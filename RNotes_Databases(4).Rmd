---
title: "RNotes - RSQL"
author: "Dr. Shoemaker"
date: "DATA 2401"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F}
#install.packages("dbplyr") ## run once per machine
library(DBI) ## in every relevant script
library(dplyr)  ## in every relevant script
library(dbplyr)  ## in every relevant script

#### for a SQLite database 
install.packages("RSQLite") ## once per machine
library(RSQLite) ## in every relevant script

### for a postgres database
#install.packages("RPostgreSQL")  ## once per machine
library(RPostgreSQL) ## in every relevant script
```

# Create a connection to the batabase
 
```{r}
db_connection <- dbConnect(SQLite(), dbname = "Chinook_Sqlite.sqlite")
```

In your environment, there is now  something there of the class "SQLiteConnection"!


Dont forget to disconnect at the end of the script! 
```{r}
dbDisconnect(db_connection)
```



# Work with the database 

So, let's work with the Database. 
```{r}
# reconnect
db_connection <- dbConnect(SQLite(), dbname = "Chinook_Sqlite.sqlite") # reconnect
```

The function dbListTables() gives a .... list of the tables. shocking. 

```{r}
dbListTables(db_connection)
```

To reference a table, we need to create a *reference* to the table as a variable. This uses the function `tbl`

```{r}
## give the connection to the database, then the name of the table you want AS A STRING
Customer_table <- tbl(db_connection,"Customer")

## print out the table reference 
print(Customer_table)
```


Let's do the same for the album table, and query just the Alanis Morissette albums

```{r}
## reference the "album" table

Album_table <- tbl(db_connection,"Album")
print(Album_table)
```

```{r}
## her artist ID is 4, so we reference that using dplyr and filter! JUST like a dataframe
Alanis_query <- Album_table %>% filter(ArtistId ==4)
print(Alanis_query)

```

 What's going on here? - `dbplyr` is automatically translating what you're asking into SQL! 

You can see the SQL commands by using `show_query`

```{r}
show_query(Alanis_query)

```

 IMPORTANT: The object AM_albums_query is NOT the data. It's a "lazy evaluation" of the query.  Querying the data is less computationally heavy then actually going to get it, so this lets you test out the statements you're making before you do it "for real"

Look above how it's called a "lazy query"


To actually get the data in a format you can use, use `collect()`

-  this command tells R to actually go "collect" the data you've queried for, to actually do the query. 

```{r}
## collect the data from our Alanis query
AM_albums <- collect(Alanis_query)

```



## Exercises

1. Use `dplyr` our databases to list, then count the number of Employees referenced in the database.
```{r}
Employee_table <- tbl(db_connection, "Employee")
Employee_table

Employee_table %>% count()

Invoice_table <- tbl(db_connection, "Invoiceline")
print(Invoice_table)

# taking database 1 queried
totals_query <- Invoice_table %>% group_by(InvoiceId) %>% summarise(total = sum(UnitPrice))
totals_sums <- collect(totals_query)
totals_sums %>% arrange(desc(total)) %>% slice_max(total)

Invoiceinfo <- tbl(db_connection, "Invoice")
print(Invoiceinfo)

nosy_query <- Invoice_table %>% group_by(InvoiceId) %>% summarise(price_total = sum(UnitPrice)) %>% 
  left_join(Invoiceinfo, by = "InvoiceId") %>% arrange(desc(price_total))

print(nosy_query)

```


2. Use `join` to add the artists to their respective albums. 

```{r}
Album_table <- tbl(db_connection,"Album")
print(Album_table)

Artist_table <- tbl(db_connection, "Artist")
print(Artist_table)

Album_Artist_query <- left_join(Album_table, Artist_table, by = "ArtistId")

Tracks_table <- tbl(db_connection,"Track")
Genre_table <- tbl(db_connection, "Genre")

#Track_Genre_query <- left_join(Tracks_table, Genre_table, by = "GenreId")

```

